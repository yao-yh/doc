# é‡æ–°å­¦ä¹ å‰ç«¯å·¥ç¨‹åŒ–ï¼šæ‰‹æ“ Vite(ä¸‰)  

> **æœ‰äº›äº‹ï¼Œä¸äº²è‡ªåŠ¨æ‰‹ï¼Œä½ æ°¸è¿œä¸ä¼šçŸ¥é“å®ƒæœ‰å¤šç®€å•â€”â€”æˆ–è€…å¤šéš¾ï¼**  
> ä»Šå¤©ï¼Œæˆ‘ä»¬ä¸åš Vite çš„æ¬è¿å·¥ï¼Œè€Œæ˜¯å°è¯•äº²æ‰‹é€ ä¸€ä¸ªè¿·ä½ ç‰ˆï¼Œå·©å›ºä¸€ä¸‹å‰ç«¯å·¥ç¨‹åŒ–çš„çŸ¥è¯†ã€‚  

### ğŸ¯ æœ¬æ¬¡ç›®æ ‡  

1. **HMR**  
   å®ç°æ–‡ä»¶çƒ­æ›´æ–°ï¼Œåœ¨å¼€å‘ç¯å¢ƒç¼–è¾‘æ–‡ä»¶æ—¶ï¼Œä¸éœ€è¦æ‰‹åŠ¨åˆ·æ–°é¡µé¢ï¼Œæå¯èƒ½æ–°å†…å®¹  

## HMR åŸºæœ¬åŸç†

æˆ‘ä»¬é¦–å…ˆæ˜ç¡®ä¸‹æ–‡ä»¶çƒ­æ›´æ–°çš„åŸç†
ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥

1.ç›‘æµ‹å¼€å‘ç¯å¢ƒæ–‡ä»¶ä¿®æ”¹
2.å½“æ–‡ä»¶ä¿®æ”¹åï¼Œé€šçŸ¥æ‰“å¼€çš„æµè§ˆå™¨æ–‡ä»¶å‘ç”Ÿå˜åŒ–
3.å½“å˜åŒ–çš„æ–‡ä»¶ä¸æ”¯æŒçƒ­æ›´æ–°æ—¶ï¼Œè‡ªåŠ¨åˆ·æ–°é¡µé¢
4.å¦‚æœå˜åŒ–çš„æ–‡ä»¶æ”¯æŒçƒ­æ›´æ–°ï¼Œåˆ™è‡ªåŠ¨é‡æ–°è¯·æ±‚å˜åŒ–çš„èµ„æº
5.æ ¹æ®å˜åŒ–çš„æ–‡ä»¶ç±»å‹ï¼Œæ‰§è¡Œç›¸å…³é€»è¾‘ï¼Œåœ¨ä¸åˆ·æ–°é¡µé¢çš„æƒ…å†µä¸‹ï¼Œå°†é¡µé¢æ•ˆæœä¿®æ”¹ä¸ºæ”¹åŠ¨åçš„æ ·å­

## ç›‘æ§æ–‡ä»¶æ˜¯å¦å‘ç”Ÿå˜åŒ–

è¿™é‡Œæˆ‘ä»¬ç”¨åˆ°ä¸€ä¸ªåº“ chokidar
æˆ‘ä»¬æ–°å»ºä¸€ä¸ªæ–‡ä»¶ hmr.js
``` javascript
// hmr.js

import path from 'node:path'
import chokidar from 'chokidar'

function createHmr(root) {
  chokidar
    .watch(path.join(root), { ignoreInitial: true })
    .on('change', (file, status) => {
      // è¿™é‡Œå…ˆæµ‹è¯•
      console.log('file changed', file)
    })
}

export { createHmr }
``` 
ä¹‹åå† index.js ä¸­è°ƒç”¨å®ƒ
``` javascript
// index.js

} else if (mode === 'dev' || mode === 'serve') {
  const { createHmr } = await import('./hmr.js')
  createHmr(root)
} else {

``` 

æµ‹è¯•ä¸‹
![Vite Logo](./æ–‡ä»¶å˜åŒ–.png)
å¼‚å¸¸ç®€å• (â—Ë‡âˆ€Ë‡â—)

## é€šçŸ¥æµè§ˆå™¨æ–‡ä»¶å˜åŒ–

ç»å¸¸èƒŒå…«è‚¡æ–‡çš„å…„å¼Ÿä»¬åº”è¯¥éƒ½çŸ¥é“ï¼Œå¸¸ç”¨çš„åç«¯ä¸»åŠ¨å‘æ¶ˆæ¯ç»™å‰ç«¯çš„æ–¹æ³•å°±ä¸¤ä¸ª webSocket å’Œ sse
ä»Šå¤©æˆ‘ä»¬ä½¿ç”¨webSocketæ¥å®ç°

æˆ‘ä»¬å†hmr.jsä¸­åšä»¥ä¸‹ä¿®æ”¹

``` javascript
// hmr.js

import { WebSocketServer } from 'ws'
import { analysisJsFromVue, analysisCssFromVue } from './plugins/vue.js'
import fs from 'node:fs'

// åœ¨å·²æœ‰çš„httpæœåŠ¡ä¸Šåˆ›å»ºä¸€ä¸ª websocket æœåŠ¡
const createWebSockerServer = (root, server) => {
  const wss = new WebSocketServer({
    server,
  })
  wss.on('connection', (ws) => {
    ws.send(JSON.stringify({ type: 'connected' }))
  })
  createHmr(root, wss)
}

// æ–‡ä»¶å˜åŒ–çš„å›è°ƒå‡½æ•°
function onfileChange(file, wss) {
  const wsContent = { type: 'update' }

  wss.clients.forEach((client) => {
    if (client.readyState === 1) {
      client.send(
        JSON.stringify(wsContent)
      )
    }
  })
}

// ç›‘æµ‹æ–‡ä»¶å˜åŒ–
function createHmr(root, wss) {
  chokidar
    .watch(path.join(root), { ignoreInitial: true })
    .on('change', (file, status) => {
      console.log('file changed', file)
      onfileChange(file, wss)
    })
}

export { createWebSockerServer }
``` 

ä¹‹åï¼Œæˆ‘ä»¬å…ˆåˆ é™¤ä¹‹å‰åœ¨ index.jsä¸­å¯åŠ¨çš„æ–‡ä»¶ç›‘å¬æœåŠ¡ï¼Œæ”¹ä¸ºç§»åŠ¨åˆ° devServer.js
``` javascript
// devServer.js

import { createWebSockerServer } from './hmr.js'

const createServer = (root, config) => {

  server.listen(port, hostName, () => {
    console.log(`start dev server:   http://${hostName}:${port}/`)
    createWebSockerServer(root, server)
  })
}

```

ä½†æ˜¯è¿™é‡Œï¼Œæˆ‘ä»¬åªæ˜¯æ–°å»ºäº†æœåŠ¡ç«¯ï¼Œè¿˜éœ€è¦å†æµè§ˆå™¨ä¸Šå¯åŠ¨ä¸€ä¸ª websocket å®¢æˆ·ç«¯æ‰è¡Œ
è¿™é‡Œå¯ä»¥å€ŸåŠ©æˆ‘ä»¬ä¹‹å‰çš„ client.js

``` javascript
// client.js
const host = new URL(import.meta.url).host
let ws = new WebSocket(`ws://${host}`)
ws.addEventListener('message', ({ data }) => {
  console.log(data)
})

```

æµ‹è¯•ä¸‹
![Vite Logo](./websocketæµ‹è¯•.png)

å¾ˆé¡ºåˆ© (*^_^*)

## å‰ç«¯è‡ªåŠ¨åˆ·æ–°

æˆ‘ä»¬ç»§ç»­ä¸‹ä¸€æ­¥
å½“ä¸€ä¸ªæ–‡ä»¶å˜åŒ–æ—¶ï¼Œæˆ‘ä»¬è¦é€šçŸ¥æµè§ˆå™¨æ–‡ä»¶å‘ç”Ÿå˜åŒ–
ä¹‹åæµè§ˆå™¨éœ€è¦è‡ªåŠ¨åˆ·æ–°

æˆ‘ä»¬å®Œå–„ä¸‹ä¹‹å‰çš„hmr.jså’Œclient.js

``` javascript
// hmr.js

// æ–‡ä»¶å˜åŒ–çš„å›è°ƒå‡½æ•°
function onfileChange(file, wss) {
  // è¿™é‡Œåº”è¯¥åˆ¤æ–­æ–‡ä»¶å¾—ç±»å‹ï¼Œæ¯”å¦‚
  // tsconfig.json éœ€è¦é‡å¯æœåŠ¡
  // vite.config.ts éœ€è¦é‡å¯æœåŠ¡
  // ã€‚ã€‚ã€‚

  let wsContent = {
    type: 'full-reload', update: {
      path: hotModules.get(file),
      type: 'js-update',
      timestamp: Date.now()
    }
  }
  wss.clients.forEach((client) => {
    if (client.readyState === 1) {
      client.send(
        JSON.stringify(wsContent)
      )
    }
  })
}

``` 
``` javascript
// client.js

// çƒ­æ›´æ–°çš„å®¢æˆ·ç«¯
class HMRClient {
  constructor() {
    this.initWebSocket()
  }

  initWebSocket() {
    const host = new URL(import.meta.url).host
    let ws = new WebSocket(`ws://${host}`)
    // ws.addEventListener('open', () => {}, { once: true })
    ws.addEventListener('message', async ({ data }) => {
      await this.handleMessage(JSON.parse(data))
    })
  }

  async handleMessage(data) {
    switch (data.type) {
      case 'full-reload':
        window.location.reload()
        break
    }
  }

}

const hmrClient = new HMRClient()

``` 

æµ‹è¯•ä¸‹æ•ˆæœ

æ‰“å¼€é¡µé¢ï¼Œä¹‹åä¿®æ”¹ä¸‹æ–‡ä»¶ï¼Œ æš—ä¸­è§‚å¯Ÿä¸‹ã€‚ã€‚ã€‚

![Vite Logo](./æµ‹è¯•å…¨é‡æ›´æ–°.png)

ç›®å‰ä¸ºæ­¢ä¸€åˆ‡é¡ºåˆ©ã€‚ã€‚

## æ”¶é›†éœ€è¦HMRçš„æ–‡ä»¶

ä¹‹åæˆ‘ä»¬è¦æ€è€ƒä¸‹ï¼Œå“ªäº›æ–‡ä»¶å¯ä»¥æ”¯æŒ çƒ­æ›´æ–°

æˆ‘ä»¬çš„æµ‹è¯•é¡¹ç›®æ˜¯vueï¼Œæ‰€ä»¥ä»Šå¤©å…ˆåªè®¨è®ºvueé¡¹ç›®äº†ã€‚ã€‚

é¦–å…ˆ é…ç½®æ–‡ä»¶ç›¸å…³ï¼Œæ¯”å¦‚ tsconfig.js vite.confid.js
è¿™äº›æ–‡ä»¶ä¿®æ”¹åï¼Œé¡¹ç›®ä¸­å¯èƒ½å¤§é‡æ–‡ä»¶æ¶‰åŠé‡æ–°ç¼–è¯‘ï¼Œé‚£è¿™æ ·çš„è¯ï¼Œçƒ­æ›´æ–°æ˜¯ä¸æ˜¯å°±æ²¡æ„ä¹‰äº†ã€‚ã€‚
å¹¶ä¸”å¦‚æœ vite.confid.js ä¸­çš„ hostå’Œportè¢«ä¿®æ”¹ï¼Œå¯èƒ½è¿˜æ¶‰åŠé‡æ–°å¯åŠ¨httpæœåŠ¡çš„é—®é¢˜ã€‚æ‰€ä»¥ä»¥ä¸Šä¸åœ¨ä»Šå¤©çš„è€ƒè™‘èŒƒå›´å†…

ç„¶åæ˜¯htmlæ–‡ä»¶ã€‚è¿™ä¸ªä¹Ÿæ˜¯ä¸èƒ½æ”¯æŒçƒ­æ›´æ–°çš„ï¼Œè¿™ä¸ªç¨å¾®å®¹æ˜“ç†è§£ã€‚ã€‚ã€‚

cssæ–‡ä»¶ï¼Œä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æ˜¯å°†cssæ–‡ä»¶è½¬æˆäº†å­—ç¬¦ä¸²ï¼Œå¹¶æ‹¼åœ¨ä¸€æ–­jsä¸­è¿”å›ç»™æµè§ˆå™¨çš„ã€‚æµè§ˆå™¨æ”¶åˆ°åï¼Œå›åˆ›å»ºä¸€ä¸ªstyleæ ‡ç­¾ï¼Œå¹¶å°†cssä»£ç å†™å…¥ã€‚
è¿™é‡Œï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯åªéœ€è¦æ‰¾åˆ°cssæ–‡ä»¶å¯¹åº”çš„é‚£ä¸ªæ ‡ç­¾ï¼Œå¹¶å°†ä»–ä¿®æ”¹æˆæ–°çš„ç‰ˆæœ¬å°±å¯ä»¥å®ç°äº†ã€‚ã€‚é‚£ä¹ˆè®¤ä¸ºcsså¯ä»¥æ”¯æŒçƒ­æ›´æ–°

.vue æ–‡ä»¶ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œvueåœ¨æ¸²æŸ“domçš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡randerå‡½æ•°å®ç°çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯åªéœ€è¦é‡æ–°è¿è¡Œä¸‹ vue randerå‡½æ•°å°±å¯ä»¥äº†ï¼Ÿ
ä¸è¿‡ï¼Œè¿™é‡Œéœ€è¦é¢å¤–æ³¨æ„ä»¥ä¸‹ã€‚å¦‚æœvueä¿®æ”¹çš„å†…å®¹ï¼Œä¸åªæ˜¯templateã€‚ä¾‹å¦‚ä»¥ä¸‹
``` javascript
const test = ref(0) => ref(1)
test.value = 2
``` 
è¿™ç§æƒ…å†µï¼Œåœ¨æˆ‘ä»¬ä¿®æ”¹ä»£ç æ—¶ï¼Œtestçš„å€¼ï¼Œå·²ç»è¢«ä¿®æ”¹äº†ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬ä¸èƒ½å°†testçš„å€¼é‡ç½®ä¸ºä»£ç ä¿®æ”¹åçš„ç‰ˆæœ¬ 1ã€‚è€Œæ˜¯ä¿æŒtestç°æœ‰çš„å€¼2.ä¹‹åå†æ‰§è¡Œranderå‡½æ•°
å‹å·ï¼Œvueå®˜æ–¹éƒ½æœ‰ç°æˆçš„æ’ä»¶ä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚ã€‚ã€‚

æœ€åæˆ‘ä»¬éœ€è¦è€ƒè™‘ä¸‹ æ™®é€šçš„ jsã€ts æ–‡ä»¶ã€‚
æ”¯æŒhmrã€‚å¾ˆé‡è¦ä¸€ä¸ªæ¡ä»¶ï¼Œæ˜¯éœ€è¦æ–‡ä»¶æ”¯æŒ å¹‚ç­‰ã€‚ä½†æ˜¯ç”±äºæ™®é€šçš„jsã€ts æ–‡ä»¶åŠŸèƒ½å„å¼‚ã€‚ä¸€èˆ¬çš„è„šæ‰‹æ¶ï¼Œéƒ½ä¸æ”¯æŒå¯¹æ™®é€šjsã€ts æ–‡ä»¶çš„çƒ­æ›´æ–°



è¿™é‡Œæˆ‘ä»¬ æ–°å¢äº†ä¸€ä¸ªmapï¼Œå½“å‰ç«¯è¯·æ±‚ä¸€ä¸ªæ–°çš„èµ„æºæ—¶ï¼Œå¦‚æœå®ƒæ”¯æŒhmrï¼ˆ.cssæˆ–.vueï¼‰ã€‚æˆ‘ä»¬æŠŠä»–ç¼“å­˜åœ¨è¿™ä¸ªmapä¸­
å½“è¿™äº›æ–‡ä»¶å˜åŒ–æ—¶ï¼Œä¸è¦é€šçŸ¥å‰ç«¯reloadï¼Œè€Œæ˜¯é€šçŸ¥æµè§ˆå™¨update


``` javascript
// hmr.js
const hotModules = new Map()


function createHmr(root, wss) {
  chokidar
    .watch(path.join(root), { ignoreInitial: true })
    .on('change', (file, status) => {
      console.log('file changed', file)
      if (hotModules.has(file)) {
        onfileChange(file, wss)
      } else {
        // ä¸æ”¯æŒ HMR çš„è¯ï¼Œç›´æ¥åˆ·æ–°å°±å¥½
        wss.clients.forEach((client) => {
          if (client.readyState === 1) {
            client.send(JSON.stringify({ type: 'full-reload' }))
          }
        })
      }
    })
}

export { createWebSockerServer, hotModules }
``` 

ä¹‹åï¼Œåœ¨æµè§ˆå™¨è¯·æ±‚èµ„æºçš„æ—¶å€™ï¼ŒæŠŠè¿™äº›è¯·æ±‚æ”¶é›†èµ·æ¥

``` javascript
// devServer.js
import { createWebSockerServer, hotModules } from './hmr.js'

async function modifyResponse(ctx) {

  } else if (uri.endsWith('.css')) {
    await modifyCss(ctx)
    hotModules.set(path.join(ROOT, ctx.request.url), ctx.request.url)
  } else if (uri.endsWith('.vue') && !ctx.request.url.includes('?type=style')) {
    await modifyVueToJs(ctx, ctx.request.url)
    hotModules.set(path.join(ROOT, ctx.request.url), ctx.request.url)
  } else if (uri.endsWith('.vue') && ctx.request.url.includes('?type=style')) {
    await modifyVueToCss(ctx, ctx.request.url)
    hotModules.set(path.join(ROOT, ctx.request.url), ctx.request.url)
  } else if (uri.endsWith('.svg')) {

}
``` 

ä¹‹åå°±æ˜¯å¯¹ä¸åŒæ–‡ä»¶çš„å¤„ç†äº†

## æµè§ˆå™¨æ›´æ–°èµ„æº

ç”±äºcssæˆ‘ä»¬ä¹Ÿæ˜¯è½¬æˆjsçš„ä»£ç ï¼Œæ‰€ä»¥è¯é¢˜å°±å˜æˆäº†æµè§ˆå™¨åŠ è½½jsèµ„æºäº†
ä½†æ˜¯ è¿™é‡Œçš„jsèµ„æºéœ€è¦æ”¯æŒæ›´æ–°ï¼Œä¹Ÿå°±æ˜¯å¯¼å…¥çš„æ˜¯å¼•ç”¨

æˆ‘ä»¬å›å¿†ä¸‹ï¼Œå‰ç«¯ç®¡ç†ä¾èµ–åŒ…çš„å¸¸ç”¨æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿæ”¯æŒå¼•ç”¨åˆæ˜¯å“ªä¸ªï¼Ÿ
æ˜¯ä¸æ˜¯æƒ³åˆ°äº†commonJS?

ä¸è¿‡ï¼Œviteçš„ä»‹ç»ä¸­ï¼Œviteæ˜¯ä½¿ç”¨esmç®¡ç†åŒ…çš„ã€‚ã€‚
æ‰€ä»¥æˆ‘ä»¬å‚è€ƒcommonJSè®¾è®¡ä»¥ä¸‹æµç¨‹
1.ç»´æŠ¤ä¸€ä¸ªhmrContentç±»ï¼Œå¯¹äºæ¯ä¸€ä¸ªèµ„æºï¼Œåˆ›å»ºä¸€ä¸ªhmrContentå¯¹è±¡
2.åœ¨hmrClientä¸­ç»´æŠ¤ä¸€ä¸ªmap å°†æ‰€æœ‰èµ„æºçš„hmrContentå¯¹è±¡ç»´æŠ¤èµ·æ¥
3.å¯ä»¥æŠŠhmrçš„å…·ä½“é€»è¾‘ï¼Œå°è£…åˆ°ä¸€ä¸ªcallbackå‡½æ•°ä¸­ï¼Œå¹¶è°ƒç”¨hmrContentå¯¹è±¡çš„æ–¹æ³•æ”¶é›†èµ·æ¥
4.èµ„æºéœ€è¦æ›´æ–°æ—¶ï¼ŒhmrClientå“åº”websocketçš„æ¶ˆæ¯ã€‚é€šè¿‡ await import(**)çš„æ–¹å¼è¯·æ±‚æ–°èµ„æº
5.èµ„æºè¯·æ±‚æ›´æ–°åï¼Œè°ƒç”¨hmrContentå¯¹è±¡æ”¶é›†çš„callback

æˆ‘ä»¬æ›´æ–°äº† client.js çš„ä»£ç 

``` javascript
// client.js
// å¯¹å•ç‹¬çš„æ–‡ä»¶è¿›è¡Œçƒ­æ›´æ–°çš„å¤„ç†
class HMRContext {
  constructor(hmrClient, ownerPath) {
    this.hmrClient = hmrClient
    this.ownerPath = ownerPath

    const mod = hmrClient.hotModulesMap.get(ownerPath)
    if (mod) {
      // å¦‚æœå­˜åœ¨ï¼Œè¯´æ˜å·²ç»æ³¨å†Œè¿‡æ¥ï¼Œéœ€è¦é‡ç½® callbacks
      mod.callbacks = []
    }
  }

  accept(deps) {
    // æ”¶é›†ä¾èµ–
    if (typeof deps === "function" || !deps) {
      const mod = this.hmrClient.hotModulesMap.get(this.ownerPath) || {
        id: this.ownerPath,
        callbacks: []
      }
      mod.callbacks.push({
        deps: [this.ownerPath],
        fn: ([mod]) => deps?.(mod)
      })
      this.hmrClient.hotModulesMap.set(this.ownerPath, mod)
    }
  }
}

// çƒ­æ›´æ–°çš„å®¢æˆ·ç«¯ï¼Œç”¨äºå¤„ç†çƒ­æ›´æ–°çš„æ¶ˆæ¯ï¼Œå¹¶å›è°ƒå¯¹åº” HMRContext çš„å¤„ç†å‡½æ•°
class HMRClient {
  constructor() {
    // ç”¨äºå­˜å‚¨æ‰€æœ‰çš„ HMRContext
    this.hotModulesMap = new Map()

    this.initWebSocket()
  }

  initWebSocket() {
    const host = new URL(import.meta.url).host
    let ws = new WebSocket(`ws://${host}`)
    // ws.addEventListener('open', () => {}, { once: true })
    ws.addEventListener('message', async ({ data }) => {
      await this.handleMessage(JSON.parse(data))
    })
  }

  async handleMessage(data) {
    switch (data.type) {
      case 'update':
        if (data.update.type === "js-update") {
          const mod = this.hotModulesMap.get(data.update.path)
          if (!mod) {
              // è¯´æ˜æ²¡æœ‰æ³¨å†Œè¿‡ï¼Œç›´æ¥è¿”å›
              return
          }
          const fetchedNewModule = await this.importUpdatedModule(data.update)
          mod.callbacks.filter( ({deps}) => {
            return deps.includes(data.update.path)
          }).forEach(({ fn }) => {
            fn([fetchedNewModule])
          })
        } else {
          // èµ„æºæ–‡ä»¶ï¼Œç›´æ¥åˆ·æ–°é¡µé¢
          // æ¯”å¦‚linkä¹‹ç±»çš„æ–‡ä»¶
          // æŸ¥æ‰¾å¯¹åº”çš„linkæ ‡ç­¾ï¼Œå°†hrefæ›¿æ¢
        }

        break
      case 'full-reload':
        window.location.reload()
        break
    }
  }
  
  async importUpdatedModule({ path, timestamp }) {
    const importPromise = import(`${path}?t=${timestamp}`)
    importPromise.catch(() => {
      window.location.reload()
    })
    return await importPromise
  }
}

const hmrClient = new HMRClient()

function createHotContext(ownerPath) {
  return new HMRContext(hmrClient, ownerPath)
}
``` 

è¿™æ ·çš„è¯ï¼Œå½“ä¸€ä¸ªæ–°èµ„æºè¢«è¯·æ±‚æˆåŠŸæ—¶ï¼Œéœ€è¦è°ƒç”¨createHotContextï¼Œç„¶åæ‰§è¡Œä¸‹acceptå°±å¯ä»¥äº†
## cssæ–‡ä»¶å¤„ç†

åˆšæ‰è¯´è¿‡ï¼Œæˆ‘ä»¬åªéœ€è¦æ‰¾åˆ°å·²æœ‰çš„styleæ ‡ç­¾ï¼Œå¹¶æ›´æ–°ä»–çš„å†…å®¹å°±å¯ä»¥äº†
æˆ‘ä»¬ä¿®æ”¹ä¸‹ä¹‹å‰çš„ updateStyleã€‚å¤šä¼ ä¸€ä¸ªidè¿›æ¥
``` javascript
// client.js

// æŠŠæ‰€æœ‰å¾—æ ·å¼æ ‡ç­¾å­˜å‚¨ï¼Œæ–¹ä¾¿åç»­æ›´æ–°
const sheetsMap = new Map();

function updateStyle(id, content) {
  let style = sheetsMap.get(id);
  if (!style) {
    const style = document.createElement('style')
    style.setAttribute('type', 'text/css')
    style.setAttribute("myvite-id", id);
    style.textContent = content
    document.head.append(style)
  } 
  sheetsMap.set(id, style);
}

```

ä¹‹åï¼Œå¯¹äºå¤„ç†cssçš„ä¸­é—´ä»¶ï¼Œåšä»¥ä¸‹ä¿®æ”¹
``` javascript
// devServer.js
async function modifyCss(ctx) {
  ctx.set('Content-Type', 'text/javascript')
  const content = await getContent(ctx.body)
  const fileName = ctx.request.url.split('/').pop().split('?')[0]
  const code = [
    `import { createHotContext } from "${CLIENT_PATH}";`,
    `const hotContext = createHotContext("${fileName}style");`,
    `import { updateStyle } from "${CLIENT_PATH}"`,
    `let css = ${JSON.stringify(content)}`,
    `updateStyle("${fileName}style", css)`,
    `hotContext.accept()`,
    ].join('\n')

  ctx.body = code
}
``` 

ä¹‹åæˆ‘ä»¬æµ‹è¯•ä¸‹

![Vite Logo](./cssæµ‹è¯•.png)

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æˆ‘ä»¬ä¸ºbodyæ·»åŠ äº†ä¸€ä¸ªèƒŒæ™¯æ ·å¼åï¼Œé€šè¿‡websocketæ”¶åˆ°äº†ä¸€ä¸ªæ›´æ–°æ¶ˆæ¯ï¼Œä¹‹åï¼Œé‡æ–°è¯·æ±‚äº†ä¸€ä¸ªcssæ–‡ä»¶ï¼Œå¹¶æ›´æ–°é¡µé¢çš„é¢œè‰²

## vueæ–‡ä»¶å¤„ç†

è¿™é‡Œæˆ‘ä»¬éœ€è¦ç”¨åˆ° vue å®˜æ–¹æ”¯æŒçš„ä¸€ä¸ªåŠŸèƒ½
\__VUE_HMR_RUNTIME__
å®ƒæ”¯æŒäº†ä¸‰ä¸ªå‡½æ•°
createRecord ç”¨äºåœ¨ HMR çš„è®°å½•è¡¨ä¸­åˆ›å»ºä¸€ä¸ªç»„ä»¶è®°å½•
rerender ç”¨äºé‡æ–°æ¸²æŸ“ç»„ä»¶ï¼Œä½†ä¸ä¼šé‡æ–°åŠ è½½æ•´ä¸ªç»„ä»¶å®šä¹‰ã€‚é€‚ç”¨äºåªä¿®æ”¹ template çš„æƒ…å†µ
reload ç”¨äºå®Œå…¨é‡æ–°åŠ è½½ç»„ä»¶å®šä¹‰ï¼Œå¹¶æ›´æ–°æ‰€æœ‰ç›¸å…³å®ä¾‹ã€‚é€‚ç”¨äºä¿®æ”¹ script çš„æƒ…å†µ

åœ¨viteä¸­ï¼Œé€šè¿‡ä¸€ä¸ªæ’ä»¶ @vite/vue æ¥å®ç° å¯¹vueçš„è§£æï¼Œå¹¶åˆ†åˆ«åˆ¤æ–­ scriptã€templateã€styleæ˜¯å¦æœ‰ä¿®æ”¹
æ ¹æ®åˆ¤æ–­ç»“æœï¼Œåˆ¤æ–­ï¼Œéœ€è¦æ‰§è¡Œrerenderè¿˜æ˜¯reloadã€‚æˆ–è€…æ˜¯åªéœ€è¦æ›´æ–°style
æˆ‘ä»¬è¿™é‡Œå°±ä¸è¦ä½¿ç”¨viteçš„æ’ä»¶äº†ã€‚æˆ‘ä»¬è‡ªå·±ç®€å•å†™å†™ç›¸å…³é€»è¾‘

é€šè¿‡ä¸€ä¸ªmapå­˜å‚¨vueæ–‡ä»¶ ä»£ç çš„hashå€¼ã€‚åœ¨vueå˜åŒ–åï¼Œé‡æ–°è®¡ç®—hashï¼Œå¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°æ–‡ä»¶
æ³¨æ„ï¼Œæœ‰äº›å˜åŒ–ï¼Œå¯èƒ½ä¸ä¼šå¯¼è‡´ä»£ç çš„ç¼–è¯‘ç»“æœå‘ç”Ÿå˜åŒ–ï¼ˆåŠ ä¸€ä¸ªç©ºæ ¼ï¼‰ã€‚éšæ„è®¡ç®—hashæ—¶ï¼Œä½¿ç”¨ç¼–è¯‘åçš„ç»“æœè®¡ç®—

æˆ‘ä»¬ æ–°å»ºä¸€ä¸ªæ–‡ä»¶ plugins/vue.js
``` javascript
// plugins/vue.js

// åˆ¤æ–­vueæ–‡ä»¶æ˜¯å¦å‘ç”Ÿå˜åŒ–å¾—ç¼“å­˜
const vueHashMap = new Map();

function analysisJsFromVue(content, filename) {
  // çœç•¥è§£æ script å’Œ template çš„ä»£ç 
  // çœç•¥å¯¹ script å’Œ template åšhashçš„ä»£ç 
  // çœç•¥é€šè¿‡ vueHashMap åˆ¤æ–­ script å’Œ template æ˜¯å¦æ›´æ–°çš„ä»£ç  
  return {
    vueScriptCodeJs,
    vueTemplateCode,
    hasStyle,
    hasChangeScript,
    hasChangeTemplate,
    scriptHash,
    templateHash
  }
}

function analysisCssFromVue(content, filename) {
  // çœç•¥è§£æ style çš„ä»£ç 
  // çœç•¥å¯¹ style åšhashçš„ä»£ç 
  // çœç•¥é€šè¿‡ vueHashMap åˆ¤æ–­ style æ˜¯å¦æ›´æ–°çš„ä»£ç  

  return { cssContent, hasChangeCss }
}

function extractJsFromVue(content, url) {
  const fileName = url.split('/').pop().split('?')[0]
  const uriName = url.split('?')[0]

  const {
    vueScriptCodeJs,
    vueTemplateCode,
    hasStyle,
    hasChangeScript,
    scriptHash
  } = analysisJsFromVue(content, fileName)

  let code = []

  if (hasStyle) {
    code.push(`import "${uriName}?type=style"`)
  }

  code = [
    `import { createHotContext } from "${CLIENT_PATH}";`,
    `const hotContext = createHotContext("${uriName}");`,
    ...code,
    vueScriptCodeJs.replace(
      'export default',
      `const main =`
    ),
    vueTemplateCode,
    `main.render = render`,
    `export const _rerender_only = ${hasChangeScript ? 'false' : 'true'}`,
    `main.__hmrId = "${scriptHash}";
typeof __VUE_HMR_RUNTIME__ !== "undefined" && __VUE_HMR_RUNTIME__.createRecord(main.__hmrId, main);
hotContext.accept((mod) => {
  if (!mod) return;
  const { default: updated, _rerender_only } = mod;
  if (_rerender_only) {
    console.log('åªæ›´æ–°template')
    __VUE_HMR_RUNTIME__.rerender(updated.__hmrId, updated.render);
  } else {
    console.log('æ›´æ–°äº†script')
    __VUE_HMR_RUNTIME__.reload(updated.__hmrId, updated);
  }
});`,
    `export default main`,
  ].join('\n')

  return { code }
}

function extractCssFromVue(content, url) {
  const fileName = url.split('/').pop()

  const { cssContent } = analysisCssFromVue(content, fileName)

  const code = [
    `import { createHotContext } from "${CLIENT_PATH}";`,
    `const hotContext = createHotContext("${url}");`,
    `import { updateStyle } from "${CLIENT_PATH}"`,
    `let css = ${JSON.stringify(cssContent)}`,
    `updateStyle("${url}", css)`,
    `hotContext.accept()`,
  ].join('\n')

  return { code }
}

export { extractJsFromVue, extractCssFromVue, analysisJsFromVue, analysisCssFromVue }
``` 

åˆ«å¿˜äº†ä¿®æ”¹devServerä¸­å¯¹åº”çš„ä¸­é—´ä»¶

``` javascript
// devServer.js
async function modifyVueToJs(ctx, url) {
  ctx.set('Content-Type', 'text/javascript')
  const content = await getContent(ctx.body)
  const { code } = extractJsFromVue(content, url)
  ctx.body = modifyImport(code)
}

async function modifyVueToCss(ctx, url) {
  ctx.set('Content-Type', 'text/javascript')
  const content = await getContent(ctx.body)
  const { code } = extractCssFromVue(content, url)
  ctx.body = code
}
``` 

æœ€ååœ¨hmrä¸­ï¼Œæ–‡ä»¶å‘ç”Ÿå˜åŒ–åï¼Œæ ¹æ®ä¸åŒæƒ…å†µï¼Œåšç›¸åº”çš„ååº”

``` javascript
// hmr.js
// æ–‡ä»¶å˜åŒ–çš„å›è°ƒå‡½æ•°
function onfileChange(file, wss) {
  let wsContent = { type: 'full-reload' }
  // è¿™é‡Œåº”è¯¥åˆ¤æ–­æ–‡ä»¶å¾—ç±»å‹ï¼Œæ¯”å¦‚
  // tsconfig.json éœ€è¦é‡å¯æœåŠ¡
  // vite.config.ts éœ€è¦é‡å¯æœåŠ¡
  // æ™®é€šjs æˆ–è€… ts æ–‡ä»¶å¯èƒ½éœ€è¦é‡æ–°åŠ è½½é¡µé¢
  // ã€‚ã€‚ã€‚

  // è¿™é‡Œåªå¤„ç† vue æ–‡ä»¶
  if (file.endsWith('vue')) {
    const fileContent = fs.readFileSync(file, 'utf-8')
    
    const { hasChangeScript, hasChangeTemplate } = analysisJsFromVue(fileContent, file)
    const { hasChangeCss } = analysisCssFromVue(fileContent, file)
    if (hasChangeScript || hasChangeTemplate) {
      wsContent = {
        type: 'update', update: {
          path: hotModules.get(file),
          type: 'js-update',
          timestamp: Date.now()
        }
      }
    } else if (hasChangeCss) {
      wsContent = {
        type: 'update', update: {
          path: hotModules.get(file) +"?type=style",
          type: 'js-update',
          timestamp: Date.now()
        }
      }
    } else {
      // ä»£ç å¾—ç¼–è¯‘ç»“æœæ²¡æœ‰å®é™…æ›´æ–° ä¸éœ€è¦æ›´æ–°
      return
    }
  } else if (file.endsWith('css')) {
    wsContent = {
      type: 'update', update: {
        path: hotModules.get(file),
        type: 'js-update',
        timestamp: Date.now()
      }
    }
  }
  wss.clients.forEach((client) => {
    if (client.readyState === 1) {
      client.send(
        JSON.stringify(wsContent)
      )
    }
  })
}
``` 

æœ€ç»ˆçš„æµ‹è¯•ç»“æœ
æˆ‘ä»¬å‡†å¤‡äº†ä»¥ä¸‹çš„æµ‹è¯•ä»£ç 

![Vite Logo](./æµ‹è¯•ä»£ç .png)


æœªå®Œå¾…ç»­~ ğŸ˜†ğŸš€  
``` javascript
// devServer.js
import { createWebSockerServer, hotModules } from './hmr.js'
``` 

![Vite Logo](./æµ‹è¯•å…¨é‡æ›´æ–°.png)
