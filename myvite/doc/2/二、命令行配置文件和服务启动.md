# é‡æ–°å­¦ä¹ å‰ç«¯å·¥ç¨‹åŒ–ï¼šæ‰‹æ“ Vite(äºŒ)  

> **æœ‰äº›äº‹ï¼Œä¸äº²è‡ªåŠ¨æ‰‹ï¼Œä½ æ°¸è¿œä¸ä¼šçŸ¥é“å®ƒæœ‰å¤šç®€å•â€”â€”æˆ–è€…å¤šéš¾ï¼**  
> ä»Šå¤©ï¼Œæˆ‘ä»¬ä¸åš Vite çš„æ¬è¿å·¥ï¼Œè€Œæ˜¯å°è¯•äº²æ‰‹é€ ä¸€ä¸ªè¿·ä½ ç‰ˆï¼Œå·©å›ºä¸€ä¸‹å‰ç«¯å·¥ç¨‹åŒ–çš„çŸ¥è¯†ã€‚  

### ğŸ¯ æœ¬æ¬¡ç›®æ ‡  

1. **å‘½ä»¤è¡Œ**ï¼šé…ç½®ä¸€ä¸ªå¯ä»¥è°ƒç”¨çš„å‘½ä»¤è¡Œå·¥å…·ã€‚  
2. **å¯åŠ¨å¼€å‘ç¯å¢ƒçš„ HTTP æœåŠ¡**ï¼Œè®©å‰ç«¯é¡µé¢èƒ½è·‘èµ·æ¥ã€‚  
3. **é…ç½®å¤„ç†**ï¼Œæ”¯æŒviteçš„å¸¸ç”¨é…ç½®ã€‚  
  

## å‘½ä»¤è¡Œå·¥å…·

æˆ‘ä»¬çŸ¥é“ï¼ŒVite æ˜¯æœ‰å‘½ä»¤è¡Œå·¥å…·çš„ï¼Œå¸¸è§çš„ `npm run dev` æœ¬è´¨ä¸Šä¹Ÿæ˜¯è°ƒç”¨ `vite`ã€‚  
æ‰§è¡Œ `vite`ï¼Œå…¶å®å°±æ˜¯å¯åŠ¨å¼€å‘ç¯å¢ƒï¼Œä¹Ÿå°±æ˜¯ `vite dev`ã€‚  
è¿è¡Œæ•ˆæœå¦‚ä¸‹ğŸ‘‡ï¼š  

![Vite Logo](./viteå‘½ä»¤è¡Œæ•ˆæœ.png)

### ğŸ› ï¸ **æ‰‹å†™ä¸€ä¸ª CLI**  

æˆ‘ä»¬å¿«é€Ÿåˆ›å»ºä¸€ä¸ªå·¥ç¨‹ï¼Œå¹¶æ–°å¢ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶ï¼š  

``` javascript
// index.js
#!/usr/bin/env node

console.log('test')
console.log(process.cwd())
console.log(process.argv)
// è¿™é‡Œå…ˆç®€å•è¾“å‡ºä¸‹å‘½ä»¤è¡Œçš„å‚æ•°ï¼Œç”¨äºæµ‹è¯•
``` 

``` javascript
// package.json
{
  "name": "myvite",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "type": "module",
  "bin": {
    "myvite": "index.js"
  },
  "dependencies": {}
}
``` 

å…ˆæ‰§è¡Œ npm linkã€‚å†æ‰§è¡Œ myvite è¿›è¡Œæµ‹è¯•ï¼š

![Vite Logo](./npmlink.png)

è¿™æ ·ï¼Œæˆ‘ä»¬çš„ CLI å°±èƒ½è·‘èµ·æ¥äº†ï¼ğŸ‰


## ğŸš€ å¼€å‘ Vite çš„å¼€å‘ç¯å¢ƒæœåŠ¡  

### ğŸ“¦ ä¾èµ–å®‰è£…  

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œè®©å‰ç«¯é¡µé¢èƒ½å¤Ÿè·‘èµ·æ¥ã€‚  
è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ **Koa** ä½œä¸ºæœåŠ¡å™¨æ¡†æ¶ï¼Œå¹¶å®‰è£…ç›¸å…³ä¾èµ–ï¼š  

```bash
npm install koa --save
npm install koa-static --save
```
æˆ‘ä»¬æ–°å»º `devServer.js` æ–‡ä»¶ï¼Œå¹¶å†™å…¥ä»¥ä¸‹ä»£ç ï¼š

``` javascript
// devServer.js
import Koa from 'koa'
import staticFiles from 'koa-static' // é™æ€èµ„æºä½¿ç”¨çš„åº“
import http from 'node:http'

const hostName = 'localhost'
const port = 5173

const app = new Koa()

const createServer = () => {
  const server = http.createServer(app.callback())

  server.listen(port, hostName, () => {
    console.log(`start dev server:   http://${hostName}:${port}/`)
  })
}
export { createServer }

``` 
ä¸ºäº†è®© `myvite` å‘½ä»¤å¯ä»¥å¯åŠ¨æœåŠ¡å™¨ï¼Œæˆ‘ä»¬ä¿®æ”¹ `index.js`ï¼š

``` javascript
// index.js

#!/usr/bin/env node

const mode = process.argv[2] || 'dev'

if (mode === 'build') {
  // todo
} else if (mode === 'dev' || mode === 'serve') {
  const { createServer } = await import('./devServer.js')
  createServer()
} else {
  console.log('mode error')
}
```
ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨
ç°åœ¨ï¼Œæˆ‘ä»¬æ‰§è¡Œ myviteï¼Œå°±å¯ä»¥å¯åŠ¨ HTTP æœåŠ¡å™¨äº†ï¼ ğŸ‰
è¿è¡Œæ•ˆæœå¦‚ä¸‹ğŸ‘‡ï¼š

ğŸ’¡ æ­¤æ—¶ï¼ŒæœåŠ¡å™¨å·²ç»å¯åŠ¨ï¼Œä½†è¿˜ä¸èƒ½è®¿é—®é™æ€èµ„æºã€‚
ğŸ”œ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥æ”¯æŒé™æ€èµ„æºåŠ è½½ï¼


![Vite Logo](./devserverå¯åŠ¨.png)

ç„¶åå°±æ˜¯é™æ€èµ„æºçš„è·å–äº†ã€‚  

åœ¨ä½¿ç”¨çœŸæ­£çš„ Vite æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `http://localhost:5173/` è®¿é—® `index.html`ï¼Œå¹¶é€šè¿‡ `http://localhost:5173/../...js`ã€`http://localhost:5173/../...css` ç­‰è·¯å¾„è®¿é—®å…¶ä»–èµ„æºã€‚  

å…¶ä¸­ `/../...js` å…¶å®å°±æ˜¯é¡¹ç›®ä¸­çš„ç›¸å¯¹è·¯å¾„ã€‚  
é‚£ä¹ˆï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥ç›´æ¥è·å–é¡¹ç›®çš„ **ç»å¯¹è·¯å¾„**ï¼Œç„¶åå°†å®ƒé…ç½®ä¸º `koa-static` çš„ `root`ï¼Œè®© Koa ç›´æ¥æä¾›é™æ€èµ„æºå‘¢ï¼Ÿ  

æˆ‘ä»¬ä¿®æ”¹å¦‚ä¸‹ä»£ç ğŸ‘‡  

### âœ¨ ä¿®æ”¹ `devServer.js`
``` javascript
// devServer.js
const app = new Koa()

// ä»¥ä¸‹ä¸ºä¿®æ”¹å†…å®¹
// è¿™é‡Œæ–°å¢ä¸€ä¸ªå‚æ•°ï¼Œç”±å¯åŠ¨è„šæœ¬å°†é¡¹ç›®ç»å¯¹è·¯å¾„ä¼ è¿‡æ¥
const createServer = (root) => {
  app.use(
    staticFiles(root)
  )
// ä»¥ä¸Šä¸ºä¿®æ”¹å†…å®¹

  const server = http.createServer(app.callback())

``` 
``` javascript
// index.js
const app = new Koa()

// ä»¥ä¸‹ä¸ºä¿®æ”¹å†…å®¹
const createServer = (root) => {
  app.use(
    staticFiles(root)
  )
// ä»¥ä¸Šä¸ºä¿®æ”¹å†…å®¹

  const server = http.createServer(app.callback())

``` 
æˆ‘ä»¬é‡æ–°è¿è¡Œé¡¹ç›®ï¼Œå¹¶åœ¨æµè§ˆå™¨ä¸­è®¿é—® `http://localhost:5173/`ã€‚  

![Vite Logo](./é…ç½®é™æ€èµ„æº.png)

å¯ä»¥çœ‹åˆ°ï¼Œä¸ä»… `index.html` èƒ½æˆåŠŸåŠ è½½ï¼Œè¿ `index.html` ä¸­å¼•ç”¨çš„ `main.ts` ä¹Ÿè¢«æˆåŠŸè·å–ã€‚  
ä¸è¿‡ï¼Œç”±äº `main.ts` ä»æ˜¯ TypeScript ä»£ç ï¼Œæµè§ˆå™¨æ— æ³•ç›´æ¥è¿è¡Œï¼Œå› æ­¤ä¼šæŠ¥ä¸€å †é”™è¯¯â€¦â€¦ğŸ˜‚  

æœ€åï¼Œæˆ‘ä»¬æ¥å¤„ç† **é…ç½®**ã€‚  

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥æŠŠ `localhost` å’Œ `5173` å†™æ­»äº†ã€‚  
ä½†åœ¨çœŸæ­£çš„ Vite ä¸­ï¼Œè¿™äº›ä¿¡æ¯éƒ½æ˜¯é€šè¿‡ **é…ç½®æ–‡ä»¶** æ¥ç®¡ç†çš„ï¼  

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç®€å•å®ç°ä¸€ä¸ª **è¯»å–é…ç½®** çš„åŠŸèƒ½ã€‚  
### ğŸ†• æ–°å»ºä¸€ä¸ªç”¨äºç”Ÿæˆé…ç½®çš„æ–‡ä»¶  

```javascript
// config.js
import { merge } from 'lodash-es'
import { pathToFileURL } from 'node:url'
import path from 'node:path'

const createConfig = async (root) => {
  const defaultConfig = {
    server: {
      hostName: 'localhost',
      port: 5173,
    },
    build: {
      // todo
    },
  }

  const myConfigName = 'myvite.config.js' // è¿™é‡Œå¯ä»¥é…ç½®å¤šä¸ªï¼Œæ¯”å¦‚ä¸€ä¸ªæ•°ç»„ï¼Œç„¶åéå†ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå­˜åœ¨çš„é…ç½®æ–‡ä»¶
  const importConfig = (
    await import(pathToFileURL(path.join(root, myConfigName)).href)
  ).default

  // å°†é»˜è®¤é…ç½®å’Œå¯¼å…¥é…ç½®åˆå¹¶
  const config = merge(defaultConfig, importConfig)
  return config
}

export { createConfig }

```
ä¹‹åä¿®æ”¹ `index.js` å’Œ `devServer.js`
```javascript
// index.js
const mode = process.argv[2] || 'dev'

// ä»¥ä¸‹ä¸ºä¿®æ”¹å†…å®¹
import { createConfig } from './config.js'
const config = await createConfig(root)

if (mode === 'build') {
  // todo
} else if (mode === 'dev' || mode === 'serve') {
  const { createServer } = await import('./devServer.js')
// ä»¥ä¸‹ä¸ºä¿®æ”¹å†…å®¹
  createServer(root, config)
```

```javascript
// devServer.js
const app = new Koa()

// ä»¥ä¸‹ä¸ºä¿®æ”¹å†…å®¹
const createServer = (root, config) => {
  const { server: serverConfig } = config
  const { hostName, port } = serverConfig
// ä»¥ä¸Šä¸ºä¿®æ”¹å†…å®¹
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª `myvite.config.js`ï¼Œç”¨äºç”¨æˆ·è‡ªå®šä¹‰é…ç½®ã€‚  
ï¼ˆè¿™é‡Œä¸èƒ½ç”¨ `myvite.config.ts`ï¼Œå› ä¸ºå½“å‰ç¯å¢ƒè¿˜æœªæ”¯æŒ TS è§£æã€‚ä¼šæŠ¥ä¸è¯†åˆ«æ–‡ä»¶çš„é”™è¯¯ã€‚ã€‚ã€‚ï¼‰  

ç„¶åï¼Œæˆ‘ä»¬ä¿®æ”¹åŸæœ‰çš„ä»£ç ï¼Œä½¿å…¶èƒ½å¤ŸåŠ è½½è¯¥é…ç½®æ–‡ä»¶ã€‚  

### ğŸ†• æ–°å»º `myvite.config.js`

```javascript
// myvite.config.js
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

// https://vite.dev/config/
export default defineConfig({
  server: {
    hostName: 'localhost',
    port: 3000,
  },
  plugins: [vue()],
})

```

é‡æ–°è¿è¡Œé¡¹ç›®åï¼Œæˆ‘ä»¬å‘ç°ç«¯å£ç¡®å®è¢«ä¿®æ”¹äº†ï¼ğŸ‰  
è¿™è¯´æ˜ `myvite.config.js` é…ç½®å·²ç»ç”Ÿæ•ˆï¼ŒæœåŠ¡å™¨æˆåŠŸç›‘å¬äº†æ–°çš„ç«¯å£ã€‚  
å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è®¿é—®æ–°åœ°å€ï¼Œä¾‹å¦‚ï¼š  

![Vite Logo](./é…ç½®ä¿®æ”¹æˆåŠŸ.png)


æœªå®Œå¾…ç»­~ ğŸ˜†ğŸš€  
